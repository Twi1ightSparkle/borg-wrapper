# Borg wrapper

<!--
Borg wrapper. An (almost) no-dependency wrapper script for basic Borg backup features.
Copyright (C) 2022  Twilight Sparkle

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->

I don't recommend relying on this script in production yet. Or, at least, frequently review and verify your backups.

<https://www.borgbackup.org/>

Borg documentation: <https://borgbackup.readthedocs.io/en/stable/>

## Setup

- Download and extract the latest [release](https://github.com/Twi1ightSparkle/borg-wrapper/releases)
- Copy the `sample.config` directory to `config`
- Edit `config/borg.env` and add your config options
- Add a secure passphrase to the first line of the `borg_passphrase` file
- Edit `exclude.txt` and `include.txt` with your requirements. One entry per line
- From the root of the repo, run `./borg-wrapper.sh --init` to initialize the repo
- **IMPORTANT: Back up your passphrase and the keyfile generated by Borg. Without these two, you will not be able to
access your backups**
- Use crontab (or the scheduler of your choice) to run `./borg-wrapper.sh --backup --automated --live` periodically.
See `crontab_example` for an example configuration
- If you need to run multiple profiles, you can use the `--config` option to specify a different config directory

See [src/help.sh](https://github.com/Twi1ightSparkle/borg/blob/main/src/help.sh) for all command line options.

## env file

Comment out or remove an option to use its default.

### Required options

<table>
    <tr>
        <th>Option</th>
        <th>Description</th>
    </tr>
    <tr>
        <td><code>TARGET_DIRECTORY</code></td>
        <td>
            <ul>
                <li>Full path to the backup target directory</li>
                <li>Local or remote</li>
                <li>The directory must be empty</li>
                <li>Directory will be created if it does not exist</li>
                <li>The parent directory must exist</li>
            </ul>
        </td>
    </tr>
</table>

### Required when `REMOTE=true`

<table>
    <tr>
        <th>Option</th>
        <th>Description</th>
    </tr>
    <tr>
        <td><code>REMOTE_DOMAIN</code></td>
        <td>FQDN or IP of the Borg backup server/target</td>
    </tr>
    <tr>
        <td><code>REMOTE_SSH_PRIVKEY</code></td>
        <td>
            Full path to the private SSH key used to log in to <code>REMOTE_DOMAIN</code>. Cannot be password protected
        </td>
    </tr>
    <tr>
        <td><code>REMOTE_USER</code></td>
        <td>Username to log in to <code>REMOTE_DOMAIN</code></td>
    </tr>
</table>

### Required when `WEBHOOK_ENABLED=true`

<table>
    <tr>
        <th>Option</th>
        <th>Description</th>
    </tr>
    <tr>
        <td><code>WEBHOOK_URL</code></td>
        <td>Your webhook URL</td>
    </tr>
</table>

### Optional options

These options are optional. If not set, the default will be used.

<table>
    <tr>
        <th>Option</th>
        <th>Default</th>
        <th>Description</th>
    </tr>
    <tr>
        <td><code>BACKUP_PASSPHRASE_FILE</code></td>
        <td><code>configDirectory/ borg_passphrase</code></td>
        <td>Full path to the file containing the passphrase. **Make sure you protect and back up this file**</td>
    </tr>
    <tr>
        <td><code>BACKUP_PREFIX</code></td>
        <td><code>hostname-</code></td>
        <td>Backup name prefix</td>
    </tr>
    <tr>
        <td><code>COMPACT_ON_BACKUP</code></td>
        <td><code>true</code></td>
        <td>Run compact after every backup</td>
    </tr>
    <tr>
        <td><code>EXCLUDE_FILE</code></td>
        <td><code>configDirectory/ exclude.txt</code></td>
        <td>Full path to the file with a list of paths to exclude in the backup</td>
    </tr>
    <tr>
        <td><code>INCLUDE_FILE</code></td>
        <td><code>configDirectory/ include.txt</code></td>
        <td>Full path to the file with a list of paths to include in the backup</td>
    </tr>
    <tr>
        <td><code>KEEP_DAILY</code></td>
        <td><code>7</code></td>
        <td>Keep this many daily backups</td>
    </tr>
    <tr>
        <td><code>KEEP_HOURLY</code></td>
        <td><code>2</code></td>
        <td>Keep this many hourly backups</td>
    </tr>
    <tr>
        <td><code>KEEP_MONTHLY</code></td>
        <td><code>12</code></td>
        <td>Keep this many monthly backups</td>
    </tr>
    <tr>
        <td><code>KEEP_WEEKLY</code></td>
        <td><code>4</code></td>
        <td>Keep this many weekly backups</td>
    </tr>
    <tr>
        <td><code>KEEP_WITHIN</code></td>
        <td><code>24H</code></td>
        <td>Keep all backups in this period</td>
    </tr>
    <tr>
        <td><code>KEEP_YEARLY</code></td>
        <td><code>-1</code> (infinitely)</td>
        <td>Keep this many yearly backups</td>
    </tr>
    <tr>
        <td><code>KEYFILE</code></td>
        <td><code>configDirectory/ keyfile</code></td>
        <td>
            Full path to the keyfile to encrypt backups with. The file cannot exist; Borg generates it.
            **Make sure you protect and back up this file**
        </td>
    </tr>
    <tr>
        <td><code>LOG_FILE</code></td>
        <td><code>configDirectory/ borg.log</code></td>
        <td>Full path to the script log file</td>
    </tr>
    <tr>
        <td><code>ONE_FILE_SYSTEM</code></td>
        <td><code>true</code></td>
        <td>Set to true to exclude mounted file systems from backup</td>
    </tr>
    <tr>
        <td><code>PRUNE_ON_BACKUP</code></td>
        <td><code>true</code></td>
        <td>Run prune after every backup</td>
    </tr>
    <tr>
        <td><code>REMOTE_PORT</code></td>
        <td><code>22</code></td>
        <td>Port to connect to <code>REMOTE_DOMAIN</code></td>
    </tr>
    <tr>
        <td><code>REMOTE</code></td>
        <td><code>false</code></td>
        <td>Back up to a remote target over SSH</td>
    </tr>
    <tr>
        <td><code>WEBHOOK_ENABLED</code></td>
        <td><code>false</code></td>
        <td>Enable logging to webhook</td>
    </tr>
    <tr>
        <td><code>WEBHOOK_VERBOSE</code></td>
        <td><code>true</code></td>
        <td>
            More verbose webhook logging. Set to false to only send a single message at the end of a successful
            operation. Only affects <code>--backup</code> and <code>--init</code>
        </td>
    </tr>
</table>

## Webhook logging

This is developed for use with [Matrix-Hookshot](https://github.com/matrix-org/matrix-hookshot) generic webhooks. Add
the Transformation JavaScript from `hookshot_webhook_js_transformation.js` to enable @room mentions for errors. Make
sure you give the webhook appservice user permissions to @room. However, this should work with any webhook reader that
accepts unauthenticated `PUT` JSON requests with the key `text`. To edit the behavior, edit the `webhook` function in
`src/utils.js` to fit your needs.

## Mac

On Mac, you must give `cron` full disk access.

- In the terminal, enter `open /usr/sbin`
- Go to `System Settings` -> `Privacy & Security` -> `Full Disk Access`
- From Finder, drag `cron` into the `Full Disk Access` window
